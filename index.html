<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Player Map</title>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.7.1/slick.min.css" />
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        width: 79%;
        height: 100%;
        display: inline-block;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #nav-panel {
        display: inline-block;
        width: 20%;
        vertical-align: top;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="nav-panel">
      <div id="carousel">
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.7.1/slick.min.js"></script>
    <script>
      
      var currentTeamIndex = 0;
      var currentPlayerIndex = 0;
      var teams = [];
      
      $.ajax({
        url: 'https://sheets.googleapis.com/v4/spreadsheets/1aIyvX4Lhh8iH8PdhcH9QnQd2pYHTTV4I09ZvzzywL7c/values/Sheet1!A:E?key=AIzaSyCmV0HtcK0cUokKKgyuuRc246xXJ8j8leQ',
        success: function (rawPlayerData) {
          if (rawPlayerData.values && rawPlayerData.values.length > 1) {
            teams = {};
            rawPlayerData = rawPlayerData.values;
            rawPlayerData.shift(); // remove header row
            for (var i = 0; i < rawPlayerData.length; i++) {
              var groupName = rawPlayerData[i][0]; // grouping in first column
              if (!teams.groupName) {
                teams[groupName] = {};
              }
            }
          }
        }
      });

      teams = [
        {
          name: "Class of 1997",
          picUrl: "http://via.placeholder.com/150/285739/000000",
          players: [
            {
              name: "player1",
              loc: {lat: 41.7, lng: -90.18}
            },
            {
              name: "player2",
              loc: {lat: 43.07, lng: -85.01}
            },
            {
              name: "player3",
              loc: {lat: 47.59, lng: -99.56}
            },
            {
              name: "player4",
              loc: {lat: 40.56, lng: -93.44}
            },
            {
              name: "player5",
              loc: {lat: 41.3, lng: -97.3}
            }
          ]
        },
        {
          name: "Class of 1995",
          picUrl: "http://via.placeholder.com/150/d38ea7/000000",
          players: [
            {
              name: "player11",
              loc: {lat: 38.7, lng: -90.18}
            },
            {
              name: "player12",
              loc: {lat: 41.07, lng: -87.01}
            },
            {
              name: "player13",
              loc: {lat: 49.59, lng: -98.56}
            },
            {
              name: "player14",
              loc: {lat: 40.56, lng: -93.44}
            },
            {
              name: "player15",
              loc: {lat: 45.3, lng: -95.3}
            }
          ]
        }
      ];

      function buildTeamCarousel(team) {
        var blob = "<div>";
        blob += "<h1>"+team.name+"</h1>";
        blob += "<img src='"+team.picUrl+"'>";
        blob += "<h4><u>Players</u></h4>";
        blob += "<ul>";
        $.each(team.players, function(i, player){
          blob += "<li><h5>"+player.name+"</h5></li>";
        });
        blob += "</ul>";
        blob += "</div>";

        return blob;
      }

      function showNextPlayer() {
        currentPlayerIndex++;

        if (currentPlayerIndex >= teams[currentTeamIndex].players.length) {
          currentTeamIndex++;
          $('#carousel').slick('slickNext');
          currentPlayerIndex = 0;
          if (currentTeamIndex >= teams.length) {
            currentTeamIndex = 0;
          }
        }

        clearMarkers();
        addMarker(teams[currentTeamIndex].players[currentPlayerIndex].loc);
      }

      $(document).ready(function() {
        $('#carousel').slick({
          arrows: false,
          pauseOnFocus: false,
          pauseOnHover: false
        });
        
        $.each(teams, function(teamIndex, team) {
          $('#carousel').slick('slickAdd',"<div>"+buildTeamCarousel(team)+"</div>");
        });
        
        setInterval(showNextPlayer, 3000);
      });

      var markers = [];
      var map;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 41.271030, lng: -96.074617},
          disableDefaultUI: true,
          styles: [
            {
              "featureType": "administrative.land_parcel",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "administrative.neighborhood",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "poi",
              "elementType": "labels.text",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "poi.business",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "elementType": "labels",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "elementType": "labels.icon",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "transit",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "water",
              "elementType": "labels.text",
              "stylers": [{"visibility": "off"}]
            }
          ]
        });
      }

      function drop(team) {
        for (var i = 0; i < team.players.length; i++) {
          addMarkerWithTimeout(team.players[i].loc, i * 200);
          clearMarkers();
        }
      }
      
      function addMarker(position) {
        markers.push(new google.maps.Marker({
          position: position,
          map: map,
          animation: google.maps.Animation.DROP,
          map_icon_label: '<span class="map-icon map-icon-tennis"></span>',
        }));
      }

      function addMarkerWithTimeout(position, timeout) {
        window.setTimeout(function() {
          addMarker(position);
        }, timeout);
      }

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
        markers = [];
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmV0HtcK0cUokKKgyuuRc246xXJ8j8leQ&callback=initMap"></script>
  </body>
</html>
