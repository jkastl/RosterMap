<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Player Map</title>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.7.1/slick.min.css" />
    <style>
      /* Always set the map height explicitly to define the size of the div element that contains the map. */
      #map {
        width: 79%;
        height: 100%;
        display: inline-block;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #nav-panel {
        display: inline-block;
        width: 20%;
        vertical-align: top;
      }
      #nav-panel .list-group-item {
        border-color: #212529;
      }
      #nav-panel .list-group-item.active {
        color: #212529;
        background-color: #ccc;
        border-color: #212529;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="nav-panel">
      <div id="carousel">
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.7.1/slick.min.js"></script>
    <script>
      
      var currentTeamIndex = 0;
      var currentPlayerIndex = 0;
      var teams = [];
      
      $.ajax({
        url: 'https://sheets.googleapis.com/v4/spreadsheets/1aIyvX4Lhh8iH8PdhcH9QnQd2pYHTTV4I09ZvzzywL7c/values/Sheet1!A:E?key=AIzaSyCmV0HtcK0cUokKKgyuuRc246xXJ8j8leQ',
        success: function (rawPlayerData) {
          if (rawPlayerData.values && rawPlayerData.values.length > 1) {
            rawPlayerData = rawPlayerData.values;
            rawPlayerData.shift(); // remove header row
            for (var playerIndex = 0; playerIndex < rawPlayerData.length; playerIndex++) {
              var teamName = rawPlayerData[playerIndex][0]; // grouping in column 0
              var teamFound = false;
              
              // check if team name exists
              if (teams.length > 0) {
                for(var teamIndex = 0; teamIndex < teams.length; teamIndex++) {
                  if (teams[teamIndex].name.toLowerCase() === teamName.toLowerCase()) {
                    teams[teamIndex].members.push({
                      id: teamIndex.toString() + '-' + playerIndex.toString(),
                      name: rawPlayerData[playerIndex][1],
                      school: rawPlayerData[playerIndex][2],
                      loc: {
                        lat: Number(rawPlayerData[playerIndex][3]),
                        lng: Number(rawPlayerData[playerIndex][4])
                      }
                    });
                    teamFound = true;
                    break;
                  }
                }
              }
              
              if (!teamFound) {
                teams.push({
                  name: teamName,
                  members: [{
                    id: teams.length.toString() + '-' + playerIndex,
                    name: rawPlayerData[playerIndex][1],
                    school: rawPlayerData[playerIndex][2],
                    loc: {
                      lat: Number(rawPlayerData[playerIndex][3]),
                      lng: Number(rawPlayerData[playerIndex][4])
                    }
                  }]
                });
              }
            }
            
            $.each(teams, function(teamIndex, team) {
              $('#carousel').slick('slickAdd',"<div>"+buildCarouselPage(team)+"</div>");
            });
          }
        }
      });

      function buildCarouselPage(team) {
        var blob = '<div>';
        blob += '<h1 class="text-center mt-2 mb-0">'+team.name+'</h1>';
        blob += '<hr class="ml-1 mt-1" />';
        blob += '<div>';
        blob += '<ul class="list-group">';
        $.each(team.members, function(i, member){
          blob += '<li data-player-id="' + member.id + '" class="ml-1 list-group-item">';
          blob += '<h4>'+member.name+'</h4>';
          blob += '<h6 class="mb-0 text-right">'+member.school+'</h6>';
          blob += '</li>';
        });
        blob += '</ul>';
        blob += '</div>';
        blob += '</div>';

        return blob;
      }
      
      function setActive(playerId) {
        $('ul .list-group-item.active').removeClass('active');
        $('ul [data-player-id="' + playerId + '"').addClass('active');
      }

      function showNextPlayer() {
        currentPlayerIndex++;

        if (currentPlayerIndex >= teams[currentTeamIndex].members.length) {
          currentTeamIndex++;
          $('#carousel').slick('slickNext');
          currentPlayerIndex = 0;
          if (currentTeamIndex >= teams.length) {
            currentTeamIndex = 0;
          }
        }

        clearMarkers();
        setActive(teams[currentTeamIndex].members[currentPlayerIndex].id);
        addMarker(teams[currentTeamIndex].members[currentPlayerIndex].loc);
      }

      $(document).ready(function() {
        $('#carousel').slick({
          arrows: false,
          pauseOnFocus: false,
          pauseOnHover: false
        });
        
        setInterval(showNextPlayer, 3000);
      });

      var markers = [];
      var map;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 41.271030, lng: -96.074617},
          disableDefaultUI: true,
          styles: [
            {
              "featureType": "administrative.land_parcel",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "administrative.neighborhood",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "poi",
              "elementType": "labels.text",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "poi.business",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "elementType": "labels",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "road",
              "elementType": "labels.icon",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "transit",
              "stylers": [{"visibility": "off"}]
            },
            {
              "featureType": "water",
              "elementType": "labels.text",
              "stylers": [{"visibility": "off"}]
            }
          ]
        });
      }

      function drop(team) {
        for (var i = 0; i < team.players.length; i++) {
          addMarkerWithTimeout(team.players[i].loc, i * 200);
          clearMarkers();
        }
      }
      
      function addMarker(position) {
        markers.push(new google.maps.Marker({
          position: position,
          map: map,
          animation: google.maps.Animation.DROP,
          map_icon_label: '<span class="map-icon map-icon-tennis"></span>',
        }));
      }

      function addMarkerWithTimeout(position, timeout) {
        window.setTimeout(function() {
          addMarker(position);
        }, timeout);
      }

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
        markers = [];
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmV0HtcK0cUokKKgyuuRc246xXJ8j8leQ&callback=initMap"></script>
  </body>
</html>
